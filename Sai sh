#!/bin/bash
set -euo pipefail

for DEV_FILE in *.dev.properties; do
  [[ -e "$DEV_FILE" ]] || continue

  BASE_NAME="${DEV_FILE%.dev.properties}"

  for ENV in uat prod; do
    TARGET_FILE="${BASE_NAME}.${ENV}.properties"

    # Create target if missing
    if [[ ! -f "$TARGET_FILE" ]]; then
      cp "$DEV_FILE" "$TARGET_FILE"
      continue
    fi

    # Ensure target ends with newline
    if [[ -s "$TARGET_FILE" ]] && [[ "$(tail -c1 "$TARGET_FILE")" != $'\n' ]]; then
      echo >> "$TARGET_FILE"
    fi

    while IFS= read -r line || [[ -n "$line" ]]; do
      # Skip comments only
      [[ "$line" =~ ^[[:space:]]*# ]] && continue
      [[ -z "$line" ]] && continue

      KEY="${line%%=*}"

      if ! grep -qE "^${KEY}=" "$TARGET_FILE"; then
        printf '%s\n' "$line" >> "$TARGET_FILE"
      fi
    done < "$DEV_FILE"

  done
done
